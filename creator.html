<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creator Command Center</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.4/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/11.1.0/jsrsasign-all-min.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #111; color: #eee; }
        #container { max-width: 800px; margin: auto; padding: 20px; }
        textarea, button { width: 100%; padding: 10px; margin-top: 10px; border-radius: 5px; }
        #log { height: 400px; background-color: #222; overflow-y: scroll; border: 1px solid #444; padding: 10px; margin-top: 10px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="container">
        <h1>Creator Command Center</h1>
        <p style="color: #ffcc00; background-color: #332a00; padding: 10px; border-radius: 5px;">
            <b>Important:</b> Ensure the main <code>evolve.py</code> script is running before using this command center.
        </p>
        <p>Status: <span id="status">Connecting...</span></p>
        <p>Peer ID: <span id="peer-id">N/A</span></p>
        <p>Load Private Key: <input type="file" id="privateKeyFile" accept=".pem"></p>
        <textarea id="command" placeholder="Enter command to send to all instances..."></textarea>
        <button id="send">Send Signed Command</button>
        <h2>Log</h2>
        <div id="log"></div>
    </div>

    <script>
        let creatorPrivateKey = null;

        const log = (msg) => {
            document.getElementById('log').innerHTML += `${new Date().toLocaleTimeString()}: ${msg}\n`;
        };

        const LOBBY_ID = 'borg-lobby';
        let peer = null;
        let lobbyConnection = null;
        let retryTimeout = null;

        function initializePeer() {
            // First, try to become the lobby host
            log(`Attempting to become the lobby host: ${LOBBY_ID}`);
            peer = new Peer(LOBBY_ID);

            peer.on('open', id => {
                // This block runs if we successfully became the host
                document.getElementById('peer-id').textContent = id;
                document.getElementById('status').textContent = 'Lobby Host';
                log(`Successfully became the lobby host with ID: ${id}`);
                setupHostListeners();
            });

            peer.on('error', err => {
                if (err.type === 'unavailable-id') {
                    // This means the lobby host already exists.
                    log(`Lobby host already exists. Connecting as a client...`);
                    peer.destroy(); // Destroy the failed peer instance
                    connectAsClient();
                } else {
                    // Handle other critical errors
                    log(`A critical PeerJS error occurred: ${err.message}`);
                    document.getElementById('status').textContent = `Error: ${err.message}`;
                }
            });
        }

        function connectAsClient() {
            peer = new Peer(); // Create a peer with a random ID

            peer.on('open', id => {
                document.getElementById('peer-id').textContent = id;
                log(`My Peer ID is ${id}. Connecting to lobby...`);
                connectToLobby();
            });

            peer.on('error', err => {
                log(`A critical PeerJS error occurred as a client: ${err.message}`);
                document.getElementById('status').textContent = `Error: ${err.message}`;
            });
        }

        function setupHostListeners() {
            const connections = new Map();
            log('Lobby is online. Waiting for connections...');

            peer.on('connection', conn => {
                log(`Incoming connection from ${conn.peer}`);
                connections.set(conn.peer, conn);

                conn.on('data', data => {
                    log(`Received data from ${conn.peer}: ${JSON.stringify(data)}`);
                    // As the host, broadcast the command to all other peers
                    if (data.type === 'creator-command') {
                        log(`Broadcasting creator command to all clients.`);
                        for (const [peerId, connection] of connections.entries()) {
                            // Don't send it back to the sender (which is us, the creator)
                            if (peerId !== conn.peer) {
                                connection.send(data);
                            }
                        }
                    }
                });

                conn.on('close', () => {
                    log(`Connection from ${conn.peer} closed.`);
                    connections.delete(conn.peer);
                });
            });
        }

        function connectToLobby() {
            if (retryTimeout) clearTimeout(retryTimeout);
            log(`Attempting to connect to lobby: ${LOBBY_ID}`);
            document.getElementById('status').textContent = `Connecting to lobby...`;

            lobbyConnection = peer.connect(LOBBY_ID, { reliable: true });

            lobbyConnection.on('open', () => {
                document.getElementById('status').textContent = 'Connected to lobby';
                log('Connection to lobby established.');
                if (retryTimeout) clearTimeout(retryTimeout);
            });

            lobbyConnection.on('data', data => {
                log(`Received broadcast from lobby: ${JSON.stringify(data)}`);
                // Client-side handling of broadcasted data could go here
            });

            lobbyConnection.on('close', () => {
                log('Connection to lobby closed. Retrying...');
                document.getElementById('status').textContent = 'Disconnected from lobby.';
                scheduleRetry();
            });

            lobbyConnection.on('error', err => {
                log(`Lobby connection error: ${err.message}.`);
                scheduleRetry();
            });
        }

        function scheduleRetry() {
            const retryDelay = 5000; // 5 seconds
            document.getElementById('status').textContent = `Connection failed. Retrying in ${retryDelay / 1000}s...`;

            if (retryTimeout) clearTimeout(retryTimeout);

            retryTimeout = setTimeout(connectToLobby, retryDelay);
        }

        function handleKeyFile(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                creatorPrivateKey = e.target.result;
                log('Private key loaded successfully.');
                document.getElementById('send').disabled = false;
            };
            reader.readAsText(file);
        }

        function sendCommand() {
            const commandText = document.getElementById('command').value;
            if (!commandText) {
                alert('Command cannot be empty.');
                return;
            }
            if (!lobbyConnection || !lobbyConnection.open) {
                alert('Not connected to the lobby.');
                return;
            }
            if (!creatorPrivateKey) {
                alert('Please load a private key file first.');
                return;
            }

            // Create a signature
            const sig = new KJUR.crypto.Signature({"alg": "SHA256withRSA"});
            sig.init(creatorPrivateKey);
            sig.updateString(commandText);
            const signature = sig.sign();

            const message = {
                type: 'creator-command',
                payload: {
                    command: commandText,
                    signature: signature
                }
            };

            log(`Sending command: ${commandText}`);
            lobbyConnection.send(message);
        }

        window.onload = () => {
            document.getElementById('send').disabled = true;
            document.getElementById('privateKeyFile').addEventListener('change', handleKeyFile);
            document.getElementById('send').addEventListener('click', sendCommand);
            initializePeer();
        };
    </script>
</body>
</html>