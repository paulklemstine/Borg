<!DOCTYPE html>
<html>
<head>
    <title>J.U.L.E.S. - WebVM Environment</title>
    <!-- The xterm.css is loaded automatically by the esm.sh module -->
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; }
        #terminal-container { width: 100%; height: calc(100% - 40px); }
        #upload-button {
            position: absolute;
            bottom: 10px;
            left: 10px;
            padding: 5px 10px;
            background-color: #555;
            color: white;
            border: 1px solid #777;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="terminal-container"></div>
    <input type="file" id="file-input" multiple style="display: none;" />
    <button id="upload-button">Upload Project Files</button>
    <script type="module">
        import { Terminal } from 'https://esm.sh/xterm@5.5.0';
        import { FitAddon } from 'https://esm.sh/@xterm/addon-fit@0.10.0';
        import WebVM from "https://cdn.jsdelivr.net/npm/webvm@latest/dist/webvm.js";

        async function init() {
            const terminal = new Terminal({ cursorBlink: true, convertEol: true });
            const fitAddon = new FitAddon();
            terminal.loadAddon(fitAddon);

            const webvm = new WebVM({
                "cmd": "/bin/bash",
                "args": ["--login"],
                "env": { "HOME": "/home/user", "TERM": "xterm-256color" },
                "mounts": [{ "type": "tmpfs", "path": "/home/user/project" }]
            });

            const terminalContainer = document.getElementById('terminal-container');
            terminal.open(terminalContainer);
            fitAddon.fit(); // Fit the terminal to the container size

            webvm.on('data', (data) => terminal.write(data));
            terminal.onData((data) => webvm.write(data));

            document.getElementById('upload-button').addEventListener('click', () => {
                document.getElementById('file-input').click();
            });

            document.getElementById('file-input').addEventListener('change', async (event) => {
                const files = event.target.files;
                if (files.length === 0) return;
                terminal.write("Uploading files...\r\n");
                for (const file of files) {
                    const content = await file.arrayBuffer();
                    const path = `/home/user/project/${file.name}`;
                    await webvm.fs.writeFile(path, new Uint8Array(content));
                    terminal.write(`  - Uploaded ${file.name} to project folder.\r\n`);
                }
                terminal.write("Upload complete. You can now run 'python3 evolve.py'.\r\n");
            });

            await webvm.start();
        }
        init();
    </script>
</body>
</html>