<!DOCTYPE html>
<html>
<head>
    <title>J.U.L.E.S. - WebVM Environment</title>
    <link rel="stylesheet" href="https://unpkg.com/xterm@5.3.0/css/xterm.css" />
    <script src="https://unpkg.com/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.min.js"></script>
    <script src="https://cxrtnc.leaningtech.com/1.0.0/cheerpOS.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; }
        #terminal-container { width: 100%; height: calc(100% - 40px); }
        #upload-button {
            position: absolute;
            bottom: 10px;
            left: 10px;
            padding: 5px 10px;
            background-color: #555;
            color: white;
            border: 1px solid #777;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="terminal-container"></div>
    <input type="file" id="file-input" multiple style="display: none;" />
    <button id="upload-button">Upload Project Files</button>
    <script>
        async function init() {
            const terminal = new window.Terminal({ cursorBlink: true, convertEol: true });
            const fitAddon = new window.FitAddon.FitAddon();
            terminal.loadAddon(fitAddon);

            const terminalContainer = document.getElementById('terminal-container');
            terminal.open(terminalContainer);
            fitAddon.fit();

            terminal.write("Welcome to J.U.L.E.S. WebVM Environment\r\n");
            terminal.write("Initializing CheerpX Virtual Machine...\r\n");

            const cheerpx = await cheerpOS.Linux.create({
                mounts: [
                    { type: "devs", path: "/dev" },
                    { type: "proc", path: "/proc" },
                    { type: "tmpfs", path: "/home/user/project" }
                ]
            });

            terminal.write("Virtual Machine is ready. Use the button to upload files.\r\n");

            const cxReadFunc = cheerpx.setCustomConsole(
                (buf) => terminal.write(new Uint8Array(buf)),
                terminal.cols,
                terminal.rows
            );
            terminal.onData((data) => {
                for (let i = 0; i < data.length; i++) {
                    cxReadFunc(data.charCodeAt(i));
                }
            });

            document.getElementById('upload-button').addEventListener('click', () => {
                document.getElementById('file-input').click();
            });

            document.getElementById('file-input').addEventListener('change', async (event) => {
                const files = event.target.files;
                if (files.length === 0) return;

                terminal.write("Uploading files...\r\n");
                for (const file of files) {
                    const content = await file.arrayBuffer();
                    const path = `/home/user/project/${file.name}`;
                    await cheerpx.writeFile(path, new Uint8Array(content));
                    terminal.write(`  - Uploaded ${file.name}\r\n`);
                }
                terminal.write("Upload complete. You can now run 'python3 evolve.py'.\r\n");
            });

            await cheerpx.run("/bin/bash");
        }

        // The cheerpOS.js script will call cheerpOSInit when it's ready.
        window.cheerpOSInit = init;
    </script>
</body>
</html>