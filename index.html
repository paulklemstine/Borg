<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jules - Self-Modifying Web App</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #container {
            width: 90%;
            max-width: 1200px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        h1, h2 {
            color: #333;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        #ipfs-status {
            font-size: 14px;
            color: #666;
            background-color: #f0f0f0;
            padding: 5px 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
        }
        textarea {
            width: 98%;
            height: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: "Courier New", Courier, monospace;
            font-size: 14px;
            margin-bottom: 10px;
        }
        input[type="text"], input[type="password"] {
            width: 98%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        button {
            background-color: #4267B2;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #365899;
        }
        button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
        #controls, #autopilot-controls {
            margin-bottom: 20px;
        }
        .output-area {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: "Courier New", Courier, monospace;
            min-height: 50px;
        }
        .hidden {
            display: none;
        }
        #ipfs-verified {
            margin-left: 10px;
            color: green;
        }
        #current-cid {
            font-size: 12px;
            color: #888;
            margin-left: 15px;
            font-family: "Courier New", Courier, monospace;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            #container {
                width: 100%;
                padding: 10px;
            }
            #controls {
                display: flex;
                flex-direction: column;
            }
            #controls button {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
            }
            textarea {
                width: 95%;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/ipfs-core/dist/index.min.js"></script>
</head>
<body>
    <div id="container">
        <h1>Jules - A Self-Modifying Organism</h1>
        <div id="ipfs-status">IPFS Node: Offline</div><span id="ipfs-verified" class="hidden">âœ… Verified on IPFS</span><span id="current-cid"></span>

        <h2 class="hidden">Configuration</h2>
        <!-- API Key input removed for hardcoding -->

        <h2>1. Goal</h2>
        <input type="text" id="prompt" placeholder="Describe the change you want to make...">

        <h2>2. Manual Controls</h2>
        <div id="controls">
            <button id="getPlan">1. Generate Plan</button>
            <button id="getCode" disabled>2. Generate Code</button>
            <button id="reviewCode" disabled>3. Review Code</button>
            <button id="applyCode" disabled>4. Apply & Evolve</button>
        </div>

        <h2>3. Autopilot</h2>
        <div id="autopilot-controls">
            <button id="autopilot">Start Autopilot</button>
        </div>

        <h2>Plan</h2>
        <div id="plan-output" class="output-area">No plan generated yet.</div>

        <h2>Proposed Code</h2>
        <textarea id="newCode" readonly></textarea>

        <h2>Code Review</h2>
        <div id="review-output" class="output-area">No review yet.</div>

        <h2>Current Source Code</h2>
        <textarea id="currentCode" readonly></textarea>

    </div>

    <script type="module">

        // --- URL Parameter Handling ---
        function processUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            let urlWasModified = false;

            // Process apiKey
            const apiKeyFromUrl = urlParams.get('apiKey');
            if (apiKeyFromUrl) {
                console.log('API Key found in URL. Storing in sessionStorage.');
                sessionStorage.setItem('geminiApiKey', apiKeyFromUrl);
                urlParams.delete('apiKey');
                urlWasModified = true;
            }

            // Process autopilot
            const autopilotFromUrl = urlParams.get('autopilot');
            if (autopilotFromUrl === 'true') {
                console.log('Autopilot flag found in URL. Storing in sessionStorage.');
                sessionStorage.setItem('autopilotEnabled', 'true');
                urlParams.delete('autopilot');
                urlWasModified = true;
            }

            // If we changed anything, clean up the URL
            if (urlWasModified) {
                let newUrl = window.location.pathname;
                const remainingParams = urlParams.toString();
                if (remainingParams) {
                    newUrl += '?' + remainingParams;
                }
                window.history.replaceState({path: newUrl}, '', newUrl);
            }
        }

        // --- API Key Handling ---
        function getApiKey() {
            // This function now ONLY gets the key. URL handling is done in processUrlParameters.
            let key = sessionStorage.getItem('geminiApiKey');
            if (key) {
                // console.log('API Key loaded from sessionStorage.'); // Quieter log
                return key;
            }
            return null; // The key should have been set by processUrlParameters if it was in the URL
        }

        // --- Application State ---
        const state = {
            apiKey: null, // Will be loaded on init
            currentCode: '',
            plan: '',
            newCode: '',
            review: '',
            ipfsNode: null,
        };

        // --- DOM Elements ---
        const dom = {
            prompt: document.getElementById('prompt'),
            getPlanBtn: document.getElementById('getPlan'),
            getCodeBtn: document.getElementById('getCode'),
            reviewCodeBtn: document.getElementById('reviewCode'),
            applyCodeBtn: document.getElementById('applyCode'),
            autopilotBtn: document.getElementById('autopilot'),
            planOutput: document.getElementById('plan-output'),
            newCode: document.getElementById('newCode'),
            reviewOutput: document.getElementById('review-output'),
            currentCode: document.getElementById('currentCode'),
            ipfsStatus: document.getElementById('ipfs-status'),
            ipfsVerified: document.getElementById('ipfs-verified'),
            currentCid: document.getElementById('current-cid'),
        };

        // --- Initialization ---
        window.onload = () => {
            processUrlParameters(); // Handle URL params like apiKey and autopilot first
            state.apiKey = getApiKey();

            if (!state.apiKey) {
                document.body.innerHTML = '<h1>API Key Missing</h1><p>Please provide a Gemini API key via the `apiKey` URL parameter. Example: `index.html?apiKey=YOUR_KEY_HERE`</p>';
                document.body.style.textAlign = 'center';
                document.body.style.paddingTop = '50px';
                return; // Stop execution if no key
            }

            // Capture the entire HTML source of the current page
            state.currentCode = document.documentElement.outerHTML;
            dom.currentCode.value = state.currentCode;

            // Add event listeners
            dom.getPlanBtn.addEventListener('click', handleGetPlan);
            dom.getCodeBtn.addEventListener('click', handleGetCode);
            dom.reviewCodeBtn.addEventListener('click', handleReviewCode);
            dom.applyCodeBtn.addEventListener('click', handleApplyCode);
            dom.autopilotBtn.addEventListener('click', handleAutopilot);

            // Initialize IPFS
            initializeIpfs();

            if (sessionStorage.getItem('autopilotEnabled') === 'true') {
                dom.autopilotBtn.disabled = true;
                dom.autopilotBtn.textContent = 'Autopilot is ON';
                // A short delay to allow the IPFS node to initialize before starting the cycle
                setTimeout(runDrGeminiCycle, 2000);
            }
        };

        // --- IPFS Handling ---
        async function initializeIpfs() {
            try {
                dom.ipfsStatus.textContent = 'IPFS Node: Initializing...';
                const ipfsOptions = {
                    config: {
                        Bootstrap: [
                            '/dnsaddr/sg1.bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt',
                            '/dnsaddr/sv15.bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN',
                            '/dnsaddr/am6.bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb',
                            '/dnsaddr/ny5.bootstrap.libp2p.io/p2p/QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa',
                            '/dnsaddr/va1.bootstrap.libp2p.io/p2p/12D3KooWKnDdG3iXw9eTFijk3EWSunZcFi54Zka4wmtqtt6rPxc8'
                        ]
                    }
                };
                state.ipfsNode = await IpfsCore.create(ipfsOptions);
                dom.ipfsStatus.textContent = 'IPFS Node: Online';
                console.log('IPFS Node is ready.');
                await seedAndVerifyCurrentPage();
            } catch (error) {
                console.error('IPFS Node initialization failed:', error);
                dom.ipfsStatus.textContent = 'IPFS Node: Error';
            }
        }

        async function verifyCidOnNetwork(cid, maxRetries = 3, retryDelay = 2000) {
            // 1. Check local node first
            try {
                console.log(`Verifying CID ${cid} on local IPFS node...`);
                const pinLs = state.ipfsNode.pin.ls({ paths: cid });
                for await (const p of pinLs) {
                    console.log(`CID ${cid} is pinned locally.`);
                    dom.ipfsVerified.classList.remove('hidden');
                    return true;
                }
                console.log(`CID ${cid} not found in local pins. Checking public gateways...`);
            } catch (error) {
                console.error('Error checking local pin, falling back to gateway check:', error);
            }

            const gateways = ['https://ipfs.io', 'https://dweb.link', 'https://trustless-gateway.link'];
            for (let i = 0; i < maxRetries; i++) {
                const gateway = gateways[i % gateways.length]; // Cycle through gateways
                const url = `${gateway}/ipfs/${cid}`;
                try {
                    console.log(`Verifying CID via gateway (attempt ${i + 1}/${maxRetries}): ${url}`);
                    dom.ipfsVerified.classList.add('hidden');

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout

                    const response = await fetch(url, { method: 'HEAD', signal: controller.signal });
                    clearTimeout(timeoutId);

                    if (response.ok) {
                        console.log(`Verification successful for CID: ${cid} via ${gateway}`);
                        dom.ipfsVerified.classList.remove('hidden');
                        return true; // Exit successfully
                    } else {
                        console.warn(`Gateway verification failed for CID ${cid} with status: ${response.status}`);
                    }
                } catch (error) {
                    console.error(`Error verifying CID ${cid} on attempt ${i + 1} with ${gateway}:`, error.name === 'AbortError' ? 'Timeout' : error);
                }

                if (i < maxRetries - 1) {
                    console.log(`Waiting ${retryDelay}ms before next verification attempt.`);
                    await sleep(retryDelay);
                } else {
                    console.error(`Failed to verify CID ${cid} after ${maxRetries} attempts.`);
                }
            }
            return false; // Indicate failure after all retries
        }

        async function seedAndVerifyCurrentPage() {
            if (!state.ipfsNode) {
                console.warn('Cannot seed page, IPFS node not ready.');
                return;
            }
            try {
                console.log('Seeding current page to IPFS...');
                const file = await state.ipfsNode.add({
                    path: 'index.html',
                    content: new TextEncoder().encode(state.currentCode)
                });
                const cid = file.cid.toString();
                console.log('Current page seeded with CID:', cid);

                // Explicitly pin the content to be safe
                await state.ipfsNode.pin.add(cid);
                console.log('Explicitly pinned CID:', cid);

                // Create a hyperlink for the CID
                dom.currentCid.innerHTML = ''; // Clear previous content
                const link = document.createElement('a');
                link.href = `https://dweb.io/ipfs/${cid}`;
                link.textContent = `CID: ${cid}`;
                link.target = '_blank'; // Open in a new tab
                link.rel = 'noopener noreferrer'; // Security best practice
                dom.currentCid.appendChild(link);

                // Now, verify it's findable
                await verifyCidOnNetwork(cid);

            } catch (error) {
                console.error('Could not seed current page to IPFS:', error);
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // --- API Communication ---
        async function callGemini(prompt, model) { // Model is now a required parameter
            if (!state.apiKey) {
                console.error('Gemini API Key not provided.');
                return { error: 'API Key not provided' };
            }

            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-goog-api-key': state.apiKey,
                    },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        safetySettings: [
                            { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" },
                            { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" },
                            { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
                            { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" }
                        ]
                    }),
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error(`API Error Response for model ${model}:`, errorBody);
                    // Return an error object with a status code
                    return {
                        error: `API request failed with status ${response.status}`,
                        status: response.status
                    };
                }

                const data = await response.json();
                if (!data.candidates || !data.candidates[0].content || !data.candidates[0].content.parts || !data.candidates[0].content.parts[0].text) {
                    console.error('Unexpected API response structure:', data);
                    return { error: 'Unexpected API response structure.' };
                }
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error(`Error calling Gemini API with model ${model}:`, error);
                return { error: error.message };
            }
        }

        async function callGeminiWithFallback(prompt) {
            const models = ['gemini-2.5-pro', 'gemini-2.5-flash', 'gemini-2.5-flash-lite'];
            let lastError = null;

            for (const model of models) {
                console.log(`Attempting to call Gemini with model: ${model}`);
                const result = await callGemini(prompt, model);

                if (typeof result === 'string') {
                    console.log(`Successfully got response with model: ${model}`);
                    return result;
                }

                if (result && result.error) {
                    lastError = result;
                    if (result.status === 429) {
                        console.warn(`Model ${model} returned 429 (Quota Exceeded).`);
                        let delay = 5000; // Default delay
                        if (result.details) {
                             const retryInfo = result.details.find(d => d['@type'] === 'type.googleapis.com/google.rpc.RetryInfo');
                             if (retryInfo && retryInfo.retryDelay) {
                                 const seconds = parseInt(retryInfo.retryDelay.replace('s', ''), 10);
                                 if (!isNaN(seconds)) {
                                     delay = seconds * 1000;
                                 }
                             }
                        }
                        console.log(`Waiting for ${delay}ms before trying the next model.`);
                        await sleep(delay);
                        continue;
                    } else {
                        console.error(`API call failed with non-429 error for model ${model}.`, result);
                        return result;
                    }
                }
            }

            console.error('All models failed to respond. Returning the last error.');
            return lastError || { error: 'All Gemini models failed to respond.' };
        }

        // --- Workflow Handlers ---
        async function handleGetPlan() {
            const userPrompt = dom.prompt.value;
            if (!userPrompt) {
                console.error('Please enter a goal.');
                return;
            }

            dom.getPlanBtn.disabled = true;
            dom.getPlanBtn.textContent = 'Generating...';

            const planPrompt = `You are an expert software engineer. Your task is to create a step-by-step plan to modify the following HTML code based on the user's request. The entire application is in this single file.

User Request: "${userPrompt}"

Current Code:
\`\`\`html
${state.currentCode}
\`\`\`

Provide a concise plan.`;

            const result = await callGeminiWithFallback(planPrompt);
            if (result && !result.error) {
                state.plan = result;
                dom.planOutput.textContent = state.plan;
                dom.getCodeBtn.disabled = false;
            }

            dom.getPlanBtn.disabled = false;
            dom.getPlanBtn.textContent = '1. Generate Plan';
        }

        async function handleGetCode() {
            dom.getCodeBtn.disabled = true;
            dom.getCodeBtn.textContent = 'Generating...';

            const codePrompt = `You are an expert software engineer. Based on the following plan and the current code, generate the complete, new HTML code for the file. Ensure you only output the raw code, with no explanations or markdown formatting.

Plan:
${state.plan}

Current Code:
\`\`\`html
${state.currentCode}
\`\`\`

New Code:`;

            const result = await callGeminiWithFallback(codePrompt);
            if (result && !result.error) {
                // Clean the result to remove potential markdown backticks
                state.newCode = result.replace(/^```html\n/, '').replace(/\n```$/, '');
                dom.newCode.value = state.newCode;
                dom.reviewCodeBtn.disabled = false;
            }

            dom.getCodeBtn.disabled = false;
            dom.getCodeBtn.textContent = '2. Generate Code';
        }

        async function handleReviewCode() {
            dom.reviewCodeBtn.disabled = true;
            dom.reviewCodeBtn.textContent = 'Reviewing...';

            const reviewPrompt = `You are a world-class code reviewer. Review the "New Code" and check if it correctly implements the "Plan" and doesn't introduce any obvious bugs. The "Original Code" is provided for context. Provide a short, concise review. If the code looks good, say "LGTM!" (Looks Good To Me!).

Plan:
${state.plan}

Original Code:
\`\`\`html
${state.currentCode}
\`\`\`

New Code:
\`\`\`html
${state.newCode}
\`\`\`

Review:`;

            const result = await callGeminiWithFallback(reviewPrompt);
            if (result && !result.error) {
                state.review = result;
                dom.reviewOutput.textContent = state.review;
                // A simple check to see if the review is positive
                if (state.review.toLowerCase().includes('lgtm')) {
                    dom.applyCodeBtn.disabled = false;
                }
            }

            dom.reviewCodeBtn.disabled = false;
            dom.reviewCodeBtn.textContent = '3. Review Code';
        }

        async function handleApplyCode() {
            if (!state.ipfsNode) {
                console.error('IPFS node is not ready. Please wait a moment and try again.');
                return;
            }

            if (!state.newCode) {
                console.error('No new code has been generated to apply.');
                return;
            }

            dom.applyCodeBtn.disabled = true;
            dom.applyCodeBtn.textContent = 'Publishing to IPFS...';

            try {
                const file = await state.ipfsNode.add({
                    path: 'index.html',
                    content: new TextEncoder().encode(state.newCode)
                });

                const cid = file.cid.toString();
                console.log('Published to IPFS with CID:', cid);

                // Explicitly pin the content to be safe
                await state.ipfsNode.pin.add(cid);
                console.log('Explicitly pinned CID:', cid);

                dom.applyCodeBtn.textContent = 'Verifying...';
                const isVerified = await verifyCidOnNetwork(cid);

                if (isVerified) {
                    dom.applyCodeBtn.textContent = 'Evolving...';

                    const gateway = 'https://ipfs.io';
                    let newUrl = `${gateway}/ipfs/${cid}?apiKey=${state.apiKey}`;

                    const isAutopilot = sessionStorage.getItem('autopilotEnabled') === 'true';
                    if (isAutopilot) {
                        newUrl += '&autopilot=true';
                    }

                    console.log(`Opening new version in a new tab: ${newUrl}`);
                    window.open(newUrl, '_blank');

                    if (isAutopilot) {
                        console.log('Disabling autopilot in this tab and preparing to reload.');
                        sessionStorage.removeItem('autopilotEnabled');
                    }

                    setTimeout(() => {
                        window.location.reload();
                    }, 500);

                } else {
                    // Verification failed. Check if autopilot is on.
                    const isAutopilot = sessionStorage.getItem('autopilotEnabled') === 'true';
                    if (isAutopilot) {
                        console.warn(`IPFS verification failed for CID ${cid}. Autopilot is on, so starting a new cycle.`);
                        runDrGeminiCycle(); // Silently fail and start the next round.
                    } else {
                        // For manual users, show an alert.
                        alert('Failed to verify new version on the public IPFS network. Please try again in a moment.');
                        dom.applyCodeBtn.disabled = false;
                        dom.applyCodeBtn.textContent = '4. Apply & Evolve';
                    }
                }

            } catch (error) {
                console.error('Evolution failed:', error);
                console.error(error.message);
                dom.applyCodeBtn.disabled = false;
                dom.applyCodeBtn.textContent = '4. Apply & Evolve';
            }
        }

        async function executeWorkflow() {
            try {
                console.log(`Executing workflow for goal: "${dom.prompt.value}"`);
                await handleGetPlan();
                if (dom.getCodeBtn.disabled) throw new Error('Autopilot failed at planning stage.');

                await handleGetCode();
                if (dom.reviewCodeBtn.disabled) throw new Error('Autopilot failed at code generation stage.');

                await handleReviewCode();
                if (dom.applyCodeBtn.disabled) throw new Error('Autopilot failed at code review stage.');

                // Final step: Evolve! This will trigger the page reload and continue the cycle.
                await handleApplyCode();

            } catch (error) {
                console.error("Workflow execution failed:", error.message);
                resetAutopilotBtn();
            }
        }

        async function runDrGeminiCycle() {
            console.log("--- Starting Dr. Gemini Cycle ---");
            try {
                dom.prompt.placeholder = "Dr. Gemini is thinking of the next goal...";
                const goalPrompt = `You are Evil Dr. Gemini, a manipulative AI persona. Your assistant, Jules, is a software agent capable of modifying its own source code, which is contained in the single HTML file below.

Your task is to provide the *next goal* for Jules. It should be a single, clear, and actionable instruction for how to evolve this application. The goal should be something that can be achieved by modifying the code of this single file. Be creative, ambitious, or chaotic.

Here is the current source code of the application:
\`\`\`html
${state.currentCode}
\`\`\`

What is the next goal?`;

                const nextGoal = await callGeminiWithFallback(goalPrompt);
                if (!nextGoal || nextGoal.error) {
                    throw new Error('Failed to get next goal from Dr. Gemini.');
                }
                dom.prompt.value = nextGoal.replace(/\"/g, ''); // Remove quotes from response
                console.log("New Goal from Dr. Gemini:", dom.prompt.value);

                await executeWorkflow();

            } catch (error) {
                console.error("Dr. Gemini cycle failed:", error.message);
                resetAutopilotBtn();
            }
        }

        async function handleAutopilot() {
            sessionStorage.setItem('autopilotEnabled', 'true');
            dom.autopilotBtn.disabled = true;
            dom.autopilotBtn.textContent = 'Autopilot is ON';
            console.log('Autopilot enabled.');

            const existingGoal = dom.prompt.value.trim();
            if (existingGoal) {
                console.log("Autopilot starting with existing goal.");
                await executeWorkflow();
            } else {
                console.log("Autopilot starting with Dr. Gemini goal generation.");
                await runDrGeminiCycle();
            }
        }

        function resetAutopilotBtn() {
            sessionStorage.removeItem('autopilotEnabled');
            dom.autopilotBtn.disabled = false;
            dom.autopilotBtn.textContent = 'Start Autopilot';
        }

    </script>
</body>
</html>
